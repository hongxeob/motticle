<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0 viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta property="og:title" content="üí´ Î™®Îù†ÌÅ¥ | ÏïÑÌã∞ÌÅ¥ ÏàòÏ†ï">
    <meta property="og:description" content="Îì±Î°ùÌïú ÏïÑÌã∞ÌÅ¥ÏùÑ ÏàòÏ†ïÌï¥Î≥¥ÏÑ∏Ïöî.">
    <meta property="og:image" content="URL to Your Image">
    <meta property="og:url" content="ec2-3-37-72-225.ap-northeast-2.compute.amazonaws.com">
    <meta property="og:type" content="website">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="/static/images/1454948.png">
    <title>Î™®Îù†ÌÅ¥ : ÏïÑÌã∞ÌÅ¥ ÏàòÏ†ï</title>
    <style>
        .button-container {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 100%;
        }

        .updateButton {
            background-color: #2DD197;
            border: none;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
            width: 100%;
            height: 40px;
            font-size: 16px;
            font-weight: 600;
            color: rgb(255 255 255);
            display: none;
        }

        .section1 {
            margin-top: -10px;
            flex-grow: 1;
            -webkit-box-flex: 1;
        }

        .link-add-button {
            position: absolute;
            inset: 129px 16px auto auto;
            width: 40px;
            height: 31.5px;
            padding-top: 3px;
            border: 0;
            border-radius: 0px 4px 4px 0px;
            background-color: rgb(90, 103, 106);
        }

        #articleLink {
            width: 100%;
            height: 32px;
            padding: 12px;
            background: rgb(194, 203, 205);
            border: 1px solid transparent;
            border-radius: 4px;
            color: rgb(90, 103, 106);
            opacity: 1;
            appearance: none;
            font-weight: 500;
            font-size: 14px;
            outline: none;
            line-height: 2;
            resize: none;
            margin-top: 10px;
        }

        .tag-wrapper {
            padding: 24px 0px;
        }

        .tag-text {
            display: block;
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 5px;
            padding-left: 4px;
        }

        .memo-text {
            display: block;
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 0px;
            padding-left: 4px;
        }

        #articleTitle,
        #linkInputContainer,
        #articleContent,
        .go-back,
        #memoContainer,
        #isPublicContainer {
            display: none;
        }

        #spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
            margin: auto;
            margin-top: -70vh;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .articleContent {
            display: none;
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 0px;
            padding-left: 4px;
            margin-top: 7px;
        }

        .articleTitleText {
            display: none;
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 0px;
            padding-left: 4px;
            margin-bottom: 7px;
        }
    </style>
</head>
<body>
<div class="view">
    <nav class="nav">
        <span onclick="goBack()" class="go-back"><</span>
        <h1 class="nav-text">ÏïÑÌã∞ÌÅ¥ ÏàòÏ†ï</h1>
        <div class="redirect-home">
            <a href="/" style="cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none">
                    <g fill-rule="evenodd" clip-path="url(#a)" clip-rule="evenodd">
                        <path fill="#535353"
                              d="M10.527.619c.414-.4.942-.619 1.487-.619.545 0 1.072.22 1.486.619l7.233 6.975 2.839 2.557c.117.105.214.236.287.383a1.437 1.437 0 0 1 .096.977 1.348 1.348 0 0 1-.205.446 1.19 1.19 0 0 1-.341.323 1.02 1.02 0 0 1-.869.108 1.103 1.103 0 0 1-.395-.23l-1-.9v10.173c0 .681-.24 1.335-.668 1.816-.428.482-1.009.753-1.614.753h-4.566v-6.423c0-.681-.24-1.335-.669-1.817-.428-.482-1.009-.752-1.614-.752-.606 0-1.186.27-1.615.752a2.741 2.741 0 0 0-.668 1.817V24H5.165c-.606 0-1.187-.27-1.615-.753a2.741 2.741 0 0 1-.668-1.816V11.257l-1 .899a1.113 1.113 0 0 1-.396.248 1.021 1.021 0 0 1-.887-.094 1.185 1.185 0 0 1-.348-.328 1.348 1.348 0 0 1-.208-.454 1.44 1.44 0 0 1 .111-.994 1.25 1.25 0 0 1 .302-.382l2.839-2.556L10.527.619Z"/>
                        <path fill="#000" fill-opacity=".2"
                              d="M10.527.619c.414-.4.942-.619 1.487-.619.545 0 1.072.22 1.486.619l7.233 6.975 2.839 2.557c.117.105.214.236.287.383a1.437 1.437 0 0 1 .096.977 1.348 1.348 0 0 1-.205.446 1.19 1.19 0 0 1-.341.323 1.02 1.02 0 0 1-.869.108 1.103 1.103 0 0 1-.395-.23l-1-.9v10.173c0 .681-.24 1.335-.668 1.816-.428.482-1.009.753-1.614.753h-4.566v-6.423c0-.681-.24-1.335-.669-1.817-.428-.482-1.009-.752-1.614-.752-.606 0-1.186.27-1.615.752a2.741 2.741 0 0 0-.668 1.817V24H5.165c-.606 0-1.187-.27-1.615-.753a2.741 2.741 0 0 1-.668-1.816V11.257l-1 .899a1.113 1.113 0 0 1-.396.248 1.021 1.021 0 0 1-.887-.094 1.185 1.185 0 0 1-.348-.328 1.348 1.348 0 0 1-.208-.454 1.44 1.44 0 0 1 .111-.994 1.25 1.25 0 0 1 .302-.382l2.839-2.556L10.527.619Z"/>
                    </g>
                    <defs>
                        <clipPath id="a">
                            <path fill="#fff" d="M0 0h24v24H0z"/>
                        </clipPath>
                    </defs>
                </svg>
            </a>
        </div>
    </nav>

    <div class="article-registration" id="articleRegistration">
        <section class="section1">
            <label class="articleTitleText" for="input-:r5:">Ï†úÎ™©</label>
            <input type="text" id="articleTitle" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.">
            <div id="linkInputContainer">
                <input type="text" id="articleLink" placeholder="ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                <button onclick="validateLink()" class="link-add-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M18 12.998h-5v5a1 1 0 0 1-2 0v-5H6a1 1 0 0 1 0-2h5v-5a1 1 0 0 1 2 0v5h5a1 1 0 0 1 0 2z"></path>
                    </svg>
                </button>
            </div>

            <div id="linkPreviewContainer"></div>
            <label class="articleContent" for="input-:r5:">ÎÇ¥Ïö©</label>
            <textarea id="articleContent" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."></textarea>
            <div id="imagePreviewContainer"></div>
            <div id="memoContainer" style="">
                <label class="memo-text" for="input-:r5:">Î©îÎ™®</label>
                <textarea id="articleMemo" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî." style="margin-top: 7px; height: 100px;"></textarea>
            </div>
            <div id="isPublicContainer">
                <span>Í≥µÍ∞úÏó¨Î∂Ä</span>
                <label for="isPublic" class="toggle-switch">
                    <input type="checkbox" id="isPublic">
                    <span class="slider"></span>
                </label>
            </div>
        </section>
        <section class="button-container">
            <button class="updateButton" onclick="updateArticle()">ÏàòÏ†ïÌïòÍ∏∞</button>
        </section>
    </div>
    <div id="spinner" class="spinner"></div>
</div>

<script>
    const accessToken = localStorage.getItem('accessToken');
    const path = window.location.pathname;
    const id = path.substring(path.lastIndexOf('/') + 1);
    let selectedType;

    function goBack() {
        window.history.back();
    }

    const isPublicCheckbox = document.getElementById('isPublic');

    isPublicCheckbox.addEventListener('change', function () {
        if (this.checked) {
            console.log('Switch is ON');
        } else {
            console.log('Switch is OFF');
        }
    });

    function updatePlaceholderAndFileInput(type) {
        selectedType = type;
        console.log(selectedType)
        const linkInputContainer = document.getElementById('linkInputContainer');
        const articleContentInput = document.getElementById('articleContent');

        articleContentInput.style.height = '350px';
        articleContentInput.readOnly = false;

        if (selectedType === 'IMAGE') {
            articleContentInput.style.height = '280px';
            articleContentInput.readOnly = true;
            linkInputContainer.style.display = 'none';
        } else if (selectedType === 'LINK') {
            articleContentInput.style.display = 'none';
            linkInputContainer.style.display = 'block';
        } else {
            linkInputContainer.style.display = 'none';
        }
    }

    function fetchDataAndUpdateUI() {
        const spinner = document.getElementById('spinner');
        spinner.style.display = 'block';

        const articleTitle = document.getElementById('articleTitle');
        const linkInputContainer = document.getElementById('linkInputContainer');
        const memoContainer = document.getElementById('memoContainer');
        const isPublicContainer = document.getElementById('isPublicContainer');
        const articleContent = document.getElementById('articleContent');
        const goBack = document.querySelector('.go-back');
        const articleContentText = document.querySelector('.articleContent');
        const articleTitleText = document.querySelector('.articleTitleText');
        const updateButton = document.querySelector('.updateButton');

        fetch(`/api/articles/${id}`, {
            method: 'GET',
            headers: {
                'Authorization': accessToken
            },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error fetching article information: ${response.statusText}`);
                }
                return response.json();
            })
            .then(articleInfo => {
                // Í∏∞Ï°¥ ÏïÑÌã∞ÌÅ¥ Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©ÌïòÏó¨ Ïù∏Ìíã ÌïÑÎìú Í∞í ÏÑ§Ï†ï
                document.getElementById('articleTitle').value = articleInfo.title;
                document.getElementById('articleContent').value = articleInfo.content;
                document.getElementById('articleLink').value = articleInfo.openGraphResponse.url;
                document.getElementById('articleMemo').value = articleInfo.memo;
                document.getElementById('isPublic').checked = articleInfo.isPublic;
                if (articleInfo.type == 'IMAGE') {
                    const articleContent = document.getElementById('articleContent');
                    articleContent.style.backgroundImage = `url(${articleInfo.content})`;
                    articleContent.value = '';
                    articleContent.placeholder = '';
                    goBack.style.display = 'block';
                    articleTitle.style.display = 'block';
                    linkInputContainer.style.display = 'none';
                    memoContainer.style.display = 'block';
                    isPublicContainer.style.display = 'block';
                    articleContent.style.display = 'block';
                    updateButton.style.display = 'block';
                    articleContentText.style.display = 'block';
                    articleTitleText.style.display = 'block';
                }
                const selectedType = articleInfo.type;
                updatePlaceholderAndFileInput(selectedType);

                if (articleInfo.type == 'TEXT') {
                    goBack.style.display = 'block';
                    articleTitle.style.display = 'block';
                    linkInputContainer.style.display = 'none';
                    memoContainer.style.display = 'block';
                    isPublicContainer.style.display = 'block';
                    articleContent.style.display = 'block';
                    updateButton.style.display = 'block';
                    articleContentText.style.display = 'block';
                    articleTitleText.style.display = 'block';
                } else if (articleInfo.type == 'LINK') {
                    goBack.style.display = 'block';
                    articleTitle.style.display = 'block';
                    linkInputContainer.style.display = 'block';
                    memoContainer.style.display = 'block';
                    isPublicContainer.style.display = 'block';
                    articleContent.style.display = 'none';
                    updateButton.style.display = 'block';
                    // articleContentText.style.display = 'none';
                    articleTitleText.style.display = 'block';
                    validateLink();
                }

            })
            .catch(error => console.error(error))
            .finally(() => {
                spinner.style.display = 'none';
            });
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ìò∏Ï∂ú
    fetchDataAndUpdateUI();

    function updateArticle() {
        const accessToken = localStorage.getItem('accessToken');
        const title = document.getElementById('articleTitle').value;

        if (title.trim() === '') {
            document.getElementById('articleTitle').style.borderColor = 'red';
            alert('Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            return;
        } else {
            document.getElementById('articleTitle').style.borderColor = '#ccc';
        }

        const isLinkType = selectedType === 'LINK';
        const isImageType = selectedType === 'IMAGE';

        let content;
        if (isLinkType) {
            content = document.getElementById('articleLink').value;
        } else if (isImageType) {
            const contentTextarea = document.getElementById('articleContent');
            const backgroundImageStyle = contentTextarea.style.backgroundImage;
            const imageUrlMatch = backgroundImageStyle.match(/url\(['"]?(.*?)['"]?\)/);
            const imageUrl = imageUrlMatch ? imageUrlMatch[1] : '';

            content = imageUrl;
        } else {
            content = document.getElementById('articleContent').value;
        }

        const memo = document.getElementById('articleMemo').value;
        const isPublic = document.getElementById('isPublic').checked;

        const data = {
            title: title,
            memo: memo,
            content: content,
            isPublic: isPublic,
        };

        fetch(`/api/articles/${id}`, {
            method: 'PATCH',
            headers: {
                'Authorization': accessToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(articleInfoRes => {
                // ÏïÑÌã∞ÌÅ¥ Îì±Î°ù ÌõÑ ÌéòÏù¥ÏßÄ Ïù¥Îèô ÎòêÎäî Îã§Î•∏ ÏûëÏóÖ ÏàòÌñâ
                console.log('ÏïÑÌã∞ÌÅ¥Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§:', articleInfoRes);
                alert("ÏïÑÌã∞ÌÅ¥Ïù¥ ÏàòÏ†ï ÎêòÏóàÏäµÎãàÎã§!")
                window.location.href = `/article/${id}`;
            })
            .catch(error => {
                console.error('ÏïÑÌã∞ÌÅ¥ ÏàòÏ†ï Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
            });
    }

    function validateLink() {
        const link = document.getElementById('articleLink').value;

        fetch(`/api/articles/validation?link=${link}`)
            .then(response => response.json())
            .then(openGraphResponse => {
                displayLinkPreview(openGraphResponse);
            })
            .catch(error => {
                console.error('ÎßÅÌÅ¨ ÌôïÏù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                alert("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎßÅÌÅ¨ÏûÖÎãàÎã§.");
            });
    }

    function displayLinkPreview(openGraphResponse) {
        const linkInputContainer = document.getElementById('linkInputContainer');
        const linkPreviewContainer = document.getElementById('linkPreviewContainer');

        // linkInputContainer.style.display = 'none';

        const articleDetails = {openGraphResponse};
        linkPreviewContainer.innerHTML = `
                <article class="article-box" style="margin-bottom: 20px;" onclick="openArticleLink('${articleDetails.openGraphResponse.url}')">
                    <section class="article-section">
                        <p class="link-article-title">${articleDetails.openGraphResponse.title}</p>
                        <span class="article-url" href="${articleDetails.openGraphResponse.url}" target="_blank">${articleDetails.openGraphResponse.url}</span>
                    </section>
                    <img src="${articleDetails.openGraphResponse.image}" alt="OG Image" class="link-type-image">
                </article>
            `;
    }

    function openArticleLink(url) {
        window.open(url, '_blank');
    }
</script>
</body>
</html>
