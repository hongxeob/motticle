<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="Your Page Title">
    <meta property="og:description" content="Your Page Description">
    <meta property="og:image" content="URL to Your Image">
    <meta property="og:url" content="URL to Your Page">
    <meta property="og:type" content="website">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/images/1454948.png">
    <title>모띠클 : 아티클 등록</title>
    <style>
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2DD197;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #4caf50;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(20.5px);
        }

        .button-container {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 100%;
        }

        .registerButton {
            background-color: #2DD197;
            border: none;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
            width: 100%;
            height: 40px;
            font-size: 16px;
            font-weight: 600;
            color: rgb(255 255 255);
        }

        .section1 {
            margin-top: -10px;
            flex-grow: 1;
            -webkit-box-flex: 1;
        }

        .link-add-button {
            position: absolute;
            inset: 147px 16px auto auto;
            cursor: pointer;
            width: 40px;
            height: 31.5px;
            padding-top: 3px;
            border: 0;
            border-radius: 0px 4px 4px 0px;
            background-color: rgb(90, 103, 106);
        }

        #articleLink {
            width: 100%;
            height: 32px;
            padding: 12px;
            background: rgb(194, 203, 205);
            border: 1px solid transparent;
            border-radius: 4px;
            color: rgb(90, 103, 106);
            opacity: 1;
            appearance: none;
            font-weight: 500;
            font-size: 14px;
            outline: none;
            line-height: 2;
            resize: none;
        }

        .tag-wrapper {
            padding-bottom: 8px;
        }

        .tag-text {
            display: block;
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 5px;
            padding-left: 4px;
            margin-top: 7px;
        }

        .memo-text {
            display: block;
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 0px;
            padding-left: 4px;
        }

        .articleTitleText {
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 0px;
            padding-left: 4px;
            margin-bottom: 7px;
        }

        .link-text {
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 7px;
            padding-left: 4px;
            display: none;
        }

        .articleContent {
            color: rgb(90, 103, 106);
            font-size: 14px;
            font-weight: 500;
            line-height: 150%;
            margin-bottom: 7px;
            padding-left: 4px;
        }


    </style>
</head>
<body>
<div class="view">
    <nav class="nav">
        <span onclick="goBack()" class="go-back"><</span>
        <h1 class="nav-text">아티클 등록</h1>
        <div class="redirect-home">
            <a href="/" style="cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none">
                    <g clip-path="url(#a)">
                        <path fill="#A6A6A6" fill-rule="evenodd"
                              d="M9.65.567C10.03.201 10.513 0 11.013 0s.983.201 1.362.567l6.63 6.395 2.602 2.343c.108.096.197.216.263.351a1.318 1.318 0 0 1 .088.896 1.236 1.236 0 0 1-.188.408c-.085.121-.192.222-.312.296a.934.934 0 0 1-.796.1 1.012 1.012 0 0 1-.363-.212l-.915-.824v9.325c0 .625-.22 1.224-.613 1.665-.393.442-.925.69-1.48.69h-4.186v-5.888c0-.624-.22-1.223-.613-1.665-.392-.442-.924-.69-1.48-.69-.554 0-1.087.248-1.48.69a2.513 2.513 0 0 0-.612 1.665V22H4.734c-.555 0-1.087-.248-1.48-.69a2.513 2.513 0 0 1-.613-1.665v-9.326l-.915.824a1.02 1.02 0 0 1-.364.227.935.935 0 0 1-.812-.086 1.086 1.086 0 0 1-.32-.3 1.237 1.237 0 0 1-.19-.417 1.32 1.32 0 0 1 .101-.91c.07-.137.165-.256.277-.351L3.02 6.963 9.65.567Z"
                              clip-rule="evenodd"/>
                    </g>
                    <defs>
                        <clipPath id="a">
                            <path fill="#fff" d="M0 0h22v22H0z"/>
                        </clipPath>
                    </defs>
                </svg>
            </a>
        </div>
    </nav>

    <div class="article-registration" id="articleRegistration">
        <section class="section1">
            <label class="articleTitleText" for="input-:r5:">제목</label>
            <input type="text" id="articleTitle" placeholder="제목을 입력하세요.">
            <label class="link-text" for="input-:r5:">링크</label>
            <div id="linkInputContainer">
                <input type="text" id="articleLink" placeholder="링크를 입력하세요">
                <button onclick="validateLink()" class="link-add-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M18 12.998h-5v5a1 1 0 0 1-2 0v-5H6a1 1 0 0 1 0-2h5v-5a1 1 0 0 1 2 0v5h5a1 1 0 0 1 0 2z"></path>
                    </svg>
                </button>
            </div>

            <div id="linkPreviewContainer"></div>
            <label class="articleContent" for="input-:r5:">내용</label>
            <textarea id="articleContent" placeholder="내용을 입력하세요."></textarea>
            <div id="imagePreviewContainer"></div>
            <input type="file" id="articleImage" accept="image/*" onchange="addImagePreview()"
                   style="display: block; margin-bottom: 0px;">
            <div class="tag-wrapper">
                <span class="tag-text">태그</span>
                <div id="tagButtonsContainer" style="cursor: pointer">
                    <button id="addTagButton" class="tag-button" onclick="navigateToAddTag()"
                            style="border: 1px solid #cdcdcd; color: #818181; margin-right: 0px;">+태그추가
                    </button>
                </div>
                <p class="tagInfoAlert">등록된 태그를 선택하거나, 원하는 태그를 등록 후 선택하여 태깅해보세요!</p>
            </div>

            <div>
                <label class="memo-text" for="input-:r5:">메모</label>
                <textarea id="articleMemo" placeholder="메모를 입력하세요." style="margin-top: 7px; height: 100px;"></textarea>
            </div>

            <span>공개여부</span>
            <label for="isPublic" class="toggle-switch">
                <input type="checkbox" id="isPublic">
                <span class="slider"></span>
            </label>
        </section>
        <section class="button-container">
            <button class="registerButton" onclick="registerArticle()">등록하기</button>
        </section>
    </div>

</div>
<div class="toast" id="toast"></div>
<script src="/js/toast.js"></script>
<script>
    function goBack() {
        window.history.back();
    }

    const isPublicCheckbox = document.getElementById('isPublic');

    isPublicCheckbox.addEventListener('change', function () {
        if (this.checked) {
            console.log('Switch is ON');
        } else {
            console.log('Switch is OFF');
        }
    });
    const accessToken = localStorage.getItem('accessToken');
    const urlParams = new URLSearchParams(window.location.search);
    const selectedType = urlParams.get('type');

    function navigateToAddTag() {
        window.location.href = '/addTag';
    }

    function updatePlaceholderAndFileInput() {
        const linkInputContainer = document.getElementById('linkInputContainer');
        const articleContentInput = document.getElementById('articleContent');
        const articleImageInput = document.getElementById('articleImage');
        const articleContentText = document.querySelector('.articleContent');
        const linkText = document.querySelector('.link-text');

        articleContentInput.placeholder = '내용을 입력하세요';
        articleImageInput.style.display = 'none';
        articleContentInput.style.height = '280px';
        articleContentInput.style.margin = '0px 7px 0px 0px';
        articleContentInput.readOnly = false;

        if (selectedType === 'IMAGE') {
            articleContentInput.placeholder = '아래 파일 선택 버튼을 눌러 이미지를 첨부하세요.';
            articleImageInput.style.display = 'block';
            articleContentInput.style.height = '240px';
            articleContentInput.readOnly = true;
            linkInputContainer.style.display = 'none';
            linkText.style.display = 'none';
        } else if (selectedType === 'LINK') {
            articleContentInput.style.display = 'none';
            linkInputContainer.style.display = 'block';
            articleContentText.style.display = 'none';
            linkText.style.display = 'block';
        } else {
            linkInputContainer.style.display = 'none';
            linkText.style.display = 'none';
        }
    }

    updatePlaceholderAndFileInput();

    function addImagePreview() {
        const imageInput = document.getElementById('articleImage');
        const articleContent = document.getElementById('articleContent');

        if (imageInput.files && imageInput.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
                articleContent.style.backgroundImage = `url(${e.target.result})`;
            };

            reader.readAsDataURL(imageInput.files[0]);
        }
    }

    function displayUserTags(tags) {
        const tagButtonsContainer = document.getElementById('tagButtonsContainer');

        if (!Array.isArray(tags)) {
            console.error('Invalid response: tags is not an array', tags);
            return;
        }
        if (tags.length === 0) {
            tagButtonsContainer.addEventListener('click', function () {
                navigateToAddTag();
            });

            return;
        }

        tags.forEach(tag => {
            const tagButton = document.createElement('button');
            tagButton.type = 'button';
            tagButton.id = `tag${tag.id}`;
            tagButton.value = tag.id;
            tagButton.className = 'tag-button';
            tagButton.textContent = `#${tag.name}`;

            tagButton.addEventListener('click', function () {
                this.classList.toggle('selected');
            });

            tagButtonsContainer.appendChild(tagButton);
            tagButtonsContainer.addEventListener('click', function (event) {
                if (event.target === tagButtonsContainer) {
                    navigateToAddTag();
                }
            });
        });
    }

    fetch('/api/tags', {
        method: 'GET',
        headers: {
            'Authorization': accessToken
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error fetching user tags: ${response.statusText}`);
            }
            return response.json();
        })
        .then(tags => {
            displayUserTags(tags.tagSliceRes);
        })
        .catch(error => console.error(error));


    function registerArticle() {

        const accessToken = localStorage.getItem('accessToken');
        const title = document.getElementById('articleTitle').value;

        if (title.trim() === '') {
            document.getElementById('articleTitle').style.borderColor = 'red';
            alert('제목을 입력하세요.');
            return;
        } else {
            document.getElementById('articleTitle').style.borderColor = '#ccc';
        }

        const isLinkType = selectedType === 'LINK';
        const content = isLinkType ? document.getElementById('articleLink').value :
            document.getElementById('articleContent').value;
        const memo = document.getElementById('articleMemo').value;
        const isPublic = document.getElementById('isPublic').checked;

        const selectedTags = Array.from(document.querySelectorAll('.tag-button.selected'))
            .map(button => parseInt(button.value));

        const data = {
            type: selectedType,
            title: title,
            content: content,
            memo: memo,
            isPublic: isPublic,
            tagIds: selectedTags,

        };

        let formData = new FormData();
        formData.append('articleAddReq', new Blob([JSON.stringify(data)], {
            type: "application/json"
        }));

        if (selectedType === 'IMAGE') {
            const imageInput = document.getElementById('articleImage');
            const imageFile = imageInput.files[0];

            formData.append('image', imageFile);
        }
        fetch('/api/articles', {
            method: 'POST',
            headers: {
                'Authorization': accessToken
            },
            body: formData,
        })
            .then(response => response.json())
            .then(articleInfoRes => {
                console.log('아티클이 성공적으로 등록되었습니다:', articleInfoRes);
                alert("아티클이 등록 되었습니다!")
                window.location.href = '/';
            })
            .catch(error => {
                console.error('아티클 등록 중 오류 발생:', error);
            });
    }

    function validateLink() {
        const link = document.getElementById('articleLink').value;

        fetch(`/api/articles/validation?link=${link}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버 오류');
                }
                return response.json();
            })
            .then(openGraphResponse => {
                displayLinkPreview(openGraphResponse);
            })
            .catch(error => {
                console.error('링크 확인 중 오류 발생:', error);
                showToast("유효하지 않은 링크입니다. 다시 입력해주세요.", true);
            });
    }


    function displayLinkPreview(openGraphResponse) {
        const linkInputContainer = document.getElementById('linkInputContainer');
        const linkPreviewContainer = document.getElementById('linkPreviewContainer');

        linkInputContainer.style.display = 'none';

        const articleDetails = {openGraphResponse};
        linkPreviewContainer.innerHTML = `
<article class="article-box" style="margin-bottom: 15px; onclick=" openArticleLink(
'${articleDetails.openGraphResponse.url}')">
<section class="article-section">
    <p class="link-article-title">${articleDetails.openGraphResponse.title}</p>
    <span class="article-url" href="${articleDetails.openGraphResponse.description}" target="_blank">${articleDetails.openGraphResponse.description}</span>
    <span class="article-url" href="${articleDetails.openGraphResponse.url}" target="_blank">${articleDetails.openGraphResponse.url}</span>
</section>
<img src="${articleDetails.openGraphResponse.image}" alt="OG Image" class="link-type-image">
</article>
`;
    }

    function openArticleLink(url) {
        window.open(url, '_blank');
    }
</script>
</body>
</html>
